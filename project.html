<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profit Protection Demo — Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <script>
    const DEFAULT_STATE = {
      projectName: "Lot 24 – Bardia",
      contractValue: 780000,
      estimatedCost: 639600,
      targetMarginPct: 18,
      variations: [
        // seed data (you can delete)
        { id: "V-012", desc: "Extra cabinetry to pantry", cost: 3200, charge: 4500, sent: true, approved: false, paid: false },
        { id: "V-013", desc: "Upgrade tiles to 600x600", cost: 2100, charge: 3200, sent: true, approved: true,  paid: false }
      ]
    };


    // ===== Policy (demo guardrails) =====
    const POLICY_KEY = "pp_demo_policy";
    const DEFAULT_POLICY = {
      minVariationMarginPct: 15,
      projectDriftTolerancePct: 1.0,
      portfolioDriftTolerancePct: 1.0,
      exposureThreshold: 20000
    };
    function loadPolicy() {
      try {
        const raw = localStorage.getItem(POLICY_KEY);
        if (!raw) return structuredClone(DEFAULT_POLICY);
        const p = JSON.parse(raw);
        return { ...structuredClone(DEFAULT_POLICY), ...p };
      } catch {
        return structuredClone(DEFAULT_POLICY);
      }
    }


    function loadState() {
      try {
        const raw = localStorage.getItem("pp_demo_state");
        if (!raw) return structuredClone(DEFAULT_STATE);
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return structuredClone(DEFAULT_STATE);
        if (!Array.isArray(parsed.variations)) parsed.variations = [];
        return parsed;
      } catch {
        return structuredClone(DEFAULT_STATE);
      }
    }

    function saveState(state) {
      localStorage.setItem("pp_demo_state", JSON.stringify(state));
    }

    function money(n) {
      const x = Number(n || 0);
      return x.toLocaleString("en-AU", { style: "currency", currency: "AUD", maximumFractionDigits: 0 });
    }

    function calc(state) {
      const baseProfit = state.contractValue - state.estimatedCost;

      let approvedCharge = 0;
      let approvedCost = 0;
      let unapprovedCharge = 0;
      let unapprovedCost = 0;

      for (const v of state.variations) {
        const isApproved = !!v.approved;
        if (isApproved) {
          approvedCharge += Number(v.charge || 0);
          approvedCost += Number(v.cost || 0);
        } else {
          unapprovedCharge += Number(v.charge || 0);
          unapprovedCost += Number(v.cost || 0);
        }
      }

      const currentProfit = baseProfit + (approvedCharge - approvedCost);
      const targetProfit = state.contractValue * (state.targetMarginPct / 100);

      const currentMarginPct = state.contractValue > 0 ? (currentProfit / state.contractValue) * 100 : 0;
      const targetMarginPct = state.targetMarginPct;

      const marginLostDollars = currentProfit - targetProfit; // negative = lost vs target
      const marginDeltaPct = currentMarginPct - targetMarginPct;

      return {
        baseProfit,
        approvedCharge, approvedCost,
        unapprovedCharge, unapprovedCost,
        currentProfit,
        targetProfit,
        currentMarginPct,
        targetMarginPct,
        marginLostDollars,
        marginDeltaPct
      };
    }

    function resetDemo() {
      saveState(structuredClone(DEFAULT_STATE));
      location.reload();
    }
  </script>

  <header class="border-b bg-white">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <div>
        <div class="text-xl font-semibold">Profit Protection System</div>
        <div class="text-sm text-slate-600">Clickable demo (no backend)</div>
      </div>
      <div class="flex gap-2">
        <a href="index.html" class="px-3 py-2 rounded-lg bg-white border text-sm">Portfolio</a>
        <a href="variation.html" class="px-3 py-2 rounded-lg bg-slate-900 text-white text-sm">+ Add Variation</a>
        <a href="approvals.html" class="px-3 py-2 rounded-lg bg-white border text-sm">Approvals</a>
        <a href="summary.html" class="px-3 py-2 rounded-lg bg-white border text-sm">Summary</a>
        <a href="policy.html" class="px-3 py-2 rounded-lg bg-white border text-sm">Policy</a>
        <button onclick="resetDemo()" class="px-3 py-2 rounded-lg bg-white border text-sm">Reset</button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6">
    <script>
      const state = loadState();
      const m = calc(state);

      const policy = loadPolicy();
      const DRIFT_TOLERANCE_PCT = Number(policy.projectDriftTolerancePct || 1.0);
      const driftPct = m.currentMarginPct - m.targetMarginPct;
    </script>

    <div class="mb-4">
      <div class="text-sm text-slate-600">Project</div>
      <div class="text-2xl font-semibold" id="projectName"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="rounded-2xl bg-white border p-4">
        <div class="text-sm text-slate-600">Contract Value</div>
        <div class="text-2xl font-semibold" id="contractValue"></div>
      </div>

      <div class="rounded-2xl bg-white border p-4">
        <div class="text-sm text-slate-600">Target Margin</div>
        <div class="text-2xl font-semibold" id="targetMargin"></div>
        <div class="text-sm text-slate-600 mt-1">Target profit: <span class="font-medium" id="targetProfit"></span></div>
      </div>

      <div class="rounded-2xl bg-white border p-4">
        <div class="text-sm text-slate-600">Current Margin (approved variations only)</div>
        <div class="text-2xl font-semibold" id="currentMargin"></div>
        <div class="text-sm text-slate-600 mt-1">Current profit: <span class="font-medium" id="currentProfit"></span></div>
      </div>
    </div>

    <div id="driftAlert" class="hidden mt-4 rounded-xl border border-red-200 bg-red-50 p-4 text-red-700">
      ⚠ Margin drift exceeds company tolerance.
    </div>

    <div class="mt-4 rounded-2xl bg-white border p-5">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-sm text-slate-600">Margin change moment</div>
          <div class="text-3xl font-semibold mt-1" id="headline"></div>
          <div class="text-sm text-slate-600 mt-2">
            This is the “hook”: add a variation, approve it, and the margin updates.
          </div>
        </div>
        <div class="text-right">
          <div class="text-sm text-slate-600">Margin vs target</div>
          <div class="text-3xl font-semibold mt-1" id="marginLost"></div>
          <div class="text-sm text-slate-600 mt-1" id="marginDelta"></div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="rounded-xl bg-slate-50 border p-4">
          <div class="text-sm text-slate-600">Approved variations</div>
          <div class="mt-2 flex items-center justify-between">
            <div class="text-sm">Client charges</div>
            <div class="font-medium" id="approvedCharge"></div>
          </div>
          <div class="mt-1 flex items-center justify-between">
            <div class="text-sm">Builder costs</div>
            <div class="font-medium" id="approvedCost"></div>
          </div>
        </div>

        <div class="rounded-xl bg-slate-50 border p-4">
          <div class="text-sm text-slate-600">Unapproved variations (risk)</div>
          <div class="mt-2 flex items-center justify-between">
            <div class="text-sm">Client charges</div>
            <div class="font-medium" id="unapprovedCharge"></div>
          </div>
          <div class="mt-1 flex items-center justify-between">
            <div class="text-sm">Builder costs</div>
            <div class="font-medium" id="unapprovedCost"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-6 rounded-2xl bg-white border p-5">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-lg font-semibold">Recent Variations</div>
          <div class="text-sm text-slate-600">Toggle approvals on the Approvals page.</div>
        </div>
        <a href="approvals.html" class="text-sm font-medium underline">Open approvals</a>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-600">
            <tr class="border-b">
              <th class="py-2 pr-4">ID</th>
              <th class="py-2 pr-4">Description</th>
              <th class="py-2 pr-4">Cost</th>
              <th class="py-2 pr-4">Charge</th>
              <th class="py-2 pr-4">Approved</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <script>
      document.getElementById("projectName").textContent = state.projectName;
      document.getElementById("contractValue").textContent = money(state.contractValue);
      document.getElementById("targetMargin").textContent = `${m.targetMarginPct.toFixed(1)}%`;
      document.getElementById("targetProfit").textContent = money(m.targetProfit);
      document.getElementById("currentMargin").textContent = `${m.currentMarginPct.toFixed(1)}%`;
      document.getElementById("currentProfit").textContent = money(m.currentProfit);

      const headline = `Margin dropped from ${m.targetMarginPct.toFixed(1)}% to ${m.currentMarginPct.toFixed(1)}%`;
      document.getElementById("headline").textContent = headline;

      if (driftPct < -DRIFT_TOLERANCE_PCT) {
        const alertBox = document.getElementById("driftAlert");
        alertBox.classList.remove("hidden");
        alertBox.innerHTML = `⚠ Margin drift exceeds tolerance (${driftPct.toFixed(1)}% vs allowed ${DRIFT_TOLERANCE_PCT}%).`;
      }

      document.getElementById("marginLost").textContent = money(m.marginLostDollars);
      document.getElementById("marginLost").className = `text-3xl font-semibold mt-1 ${m.marginLostDollars < 0 ? "text-red-600" : "text-emerald-700"}`;
      document.getElementById("marginDelta").textContent = `${m.marginDeltaPct >= 0 ? "+" : ""}${m.marginDeltaPct.toFixed(1)}% vs target`;

      document.getElementById("approvedCharge").textContent = money(m.approvedCharge);
      document.getElementById("approvedCost").textContent = money(m.approvedCost);
      document.getElementById("unapprovedCharge").textContent = money(m.unapprovedCharge);
      document.getElementById("unapprovedCost").textContent = money(m.unapprovedCost);

      const rows = document.getElementById("rows");
      const recent = [...state.variations].slice(-6).reverse();
      rows.innerHTML = recent.map(v => `
        <tr class="border-b">
          <td class="py-2 pr-4 font-medium">${v.id}</td>
          <td class="py-2 pr-4">${v.desc}</td>
          <td class="py-2 pr-4">${money(v.cost)}</td>
          <td class="py-2 pr-4">${money(v.charge)}</td>
          <td class="py-2 pr-4">${v.approved ? "Yes" : "No"}</td>
        </tr>
      `).join("");
    </script>
  </main>
</body>
</html>
